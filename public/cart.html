<!--public/cart.html-->
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velora | Sepetim</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        header { background-color: #000; padding: 20px 0 10px; border-bottom: 2px solid #d4af37; }
        nav { display: flex; justify-content: center; align-items: center; gap: 30px; }
        nav a { color: #f5f5f5; text-decoration: none; font-weight: 600; letter-spacing: 1px; }
        nav a:hover { color: #d4af37; }

        .form-container { max-width: 950px; margin: 40px auto; padding: 20px; }
        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0d0d0d;
            border: 1px solid #d4af37;
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 15px;
            gap: 20px;
        }

        .cart-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #333; }
        
        .item-details { flex: 2; display: flex; align-items: center; gap: 15px; color: #fff; font-size: 1.1em; }
        .item-price { flex: 1; color: #d4af37; font-weight: bold; text-align: center; font-size: 1.1em; }
        
        .item-actions { display: flex; align-items: center; gap: 10px; }
        .action-btn { 
            width: 30px; height: 30px; border-radius: 6px; border: none; cursor: pointer; 
            font-weight: bold; transition: 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .inc-btn { background-color: #d4af37; color: #000; font-size: 1.2em; }
        .rem-btn { background-color: #e74c3c; color: #fff; font-size: 0.9em; }
        .action-btn:hover { transform: scale(1.1); opacity: 0.8; }

        .checkout-section { 
            margin-top: 30px; padding-top: 20px; border-top: 2px solid #d4af37; text-align: right; 
        }
        .total-price { color: #ffffff; font-size: 1.0em; font-weight: bold; margin-bottom: 10px; }
        .buy-btn {
            background: #d4af37; color: #000; padding: 12px 20px; border: none; 
            border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.8em;
        }

        @media (max-width: 768px) {
            .cart-item { flex-direction: column; text-align: center; }
            .item-details { flex-direction: column; }
        }
    </style>
</head>
<body>

<header>
    <h1 style="color: #d4af37; text-align: center;">VELORA</h1>
    <nav id="navMenu">
        <a href="index.html">ANA SAYFA</a>
        <a href="products.html">ÃœRÃœNLER</a>
        <a href="favorites.html">FAVORÄ°LER</a>
        <a href="orders.html">SÄ°PARÄ°ÅžLERÄ°M</a>
        <a href="#" id="logoutBtn">Ã‡IKIÅž</a>
    </nav>
</header>

<div class="form-container">
    <h2 style="color:#fff; margin-bottom: 20px;">SEPETÄ°M</h2>
    <div id="cartItems">YÃ¼kleniyor...</div>
    
    <div class="checkout-section" id="checkoutSection" style="display:none;">
        <div class="total-price">Genel Toplam: <span id="totalPrice">0</span> â‚º</div>
        <button id="checkoutBtn" class="buy-btn">SEPETÄ° ONAYLA</button>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    async function loadCart() {
        try {
            const res = await fetch("/api/cart", { headers: { "Authorization": "Bearer " + token } });
            const cart = await res.json();
            const container = document.getElementById("cartItems");
            const checkoutSection = document.getElementById("checkoutSection");

            if (!cart.items || cart.items.length === 0) {
                container.innerHTML = "<p style='color:#888; text-align:center;'>Sepetiniz ÅŸu an boÅŸ.</p>";
                checkoutSection.style.display = "none";
                return;
            }

            checkoutSection.style.display = "block";
            container.innerHTML = "";
            let total = 0;

            cart.items.forEach(item => {
                // Hata Ã¶nleme: ÃœrÃ¼n silinmiÅŸse veya gelmiyorsa atla
                if (!item.product) return;

                total += item.product.price * item.quantity;
                const div = document.createElement("div");
                div.className = "cart-item";
                div.innerHTML = `
                    <img src="${item.product.image || '/resimler/default.png'}">
                    <div class="item-details">
                        <strong>${item.product.name}</strong>
                        <span style="color:#d4af37;">(x${item.quantity})</span>
                    </div>
                    <div class="item-price">${(item.product.price * item.quantity).toFixed(2)} â‚º</div>
                    <div class="item-actions">
                        <button class="action-btn inc-btn" onclick="changeQty('${item.product._id}', 1)">+</button>
                        <button class="action-btn rem-btn" onclick="removeItem('${item.product._id}')">ðŸ—‘</button>
                    </div>
                `;
                container.appendChild(div);
            });
            document.getElementById("totalPrice").innerText = total.toFixed(2);
        } catch (err) { console.error("Sepet hatasÄ±:", err); }
    }

    async function changeQty(productId, quantity) {
        await fetch("/api/cart/add", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify({ productId, quantity })
        });
        loadCart();
    }

    async function removeItem(productId) {
        await fetch("/api/cart/remove/" + productId, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
        });
        loadCart();
    }

    document.getElementById("checkoutBtn").onclick = async () => {
        try {
            // Butonu geÃ§ici olarak devre dÄ±ÅŸÄ± bÄ±rak (Ã§ift tÄ±klamayÄ± Ã¶nlemek iÃ§in)
            const btn = document.getElementById("checkoutBtn");
            btn.disabled = true;
            btn.innerText = "Ä°ÅžLENÄ°YOR...";

            const res = await fetch("/api/cart/checkout", {
                method: "POST",
                headers: { 
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });
            
            const data = await res.json();
            if (data.success) {
                alert("SipariÅŸiniz baÅŸarÄ±yla alÄ±ndÄ±!");
                window.location.href = "orders.html";
            } else {
                alert(data.message || "Hata: " + (data.error || "Bilinmeyen hata"));
                btn.disabled = false;
                btn.innerText = "SEPETÄ° ONAYLA";
            }
        } catch (err) { 
            alert("Sistem hatasÄ± oluÅŸtu!"); 
            console.error(err);
        }
    };

    document.getElementById("logoutBtn").onclick = () => {
        localStorage.clear();
        window.location.href = "login.html";
    };

    loadCart();
</script>
</body>
</html>