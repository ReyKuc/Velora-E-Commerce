<!--public/orders.html-->
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velora | SipariÅŸlerim</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        header { background-color: #000; padding: 20px 0 10px; border-bottom: 2px solid #d4af37; position: sticky; top:0; z-index:1000; }
        nav { display: flex; justify-content: center; align-items: center; gap: 30px; }
        nav a { color: #f5f5f5; text-decoration: none; font-weight: 600; }

        .form-container { max-width: 950px; margin: 40px auto; padding: 20px; }
        .order-card {
            border: 1px solid #d4af37; border-radius: 15px; padding: 25px;
            margin-bottom: 30px; background-color: #0d0d0d; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .order-date { 
            display: block; color: #d4af37; font-weight: bold; border-bottom: 1px solid #333; 
            padding-bottom: 10px; margin-bottom: 15px; font-size: 1.1em;
        }
        .order-product-row {
            display: flex; align-items:center; justify-content: space-between;
            background: #151515; padding: 15px; border-radius: 10px; margin-bottom: 12px;
        }
        .product-info { display: flex; align-items: center; gap: 15px; flex: 2; }
        .order-product-image { width: 65px; height: 65px; object-fit: cover; border-radius: 8px; }
        
        .review-btn {
            background: #d4af37; color: #000; border: none; padding: 8px 10px;
            border-radius: 6px; font-weight: bold; font-size: 0.8em; cursor: pointer; transition: 0.3s;
        }
        .review-btn:hover { background: #fff; }
        .order-total { text-align: right; font-size: 1.1em; color: #ffffff; font-weight: bold; margin-top: 20px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; }
        .modal-content { background: #1f1f1f; border: 2px solid #d4af37; border-radius: 15px; padding: 30px; max-width: 400px; margin: 10% auto; text-align: center; }
        .stars span { font-size: 30px; cursor: pointer; color: #ffd700; margin: 0 5px; }
        textarea { width: 100%; height: 80px; margin-top: 15px; background: #000; color: #fff; border: 1px solid #d4af37; border-radius: 8px; padding: 10px; font-family: sans-serif; resize: none; }
    </style>
</head>
<body>

<header>
    <h1 style="color: #d4af37; text-align: center;">VELORA</h1>
    <nav>
        <a href="index.html">ANA SAYFA</a>
        <a href="products.html">ÃœRÃœNLER</a>
        <a href="cart.html">SEPETÄ°M</a>
        <a href="favorites.html">FAVORÄ°LER</a>
    </nav>
</header>

<div class="form-container">
    <h2 style="color: #fff; text-align: center; margin-bottom: 30px;">SipariÅŸ GeÃ§miÅŸim</h2>
    <div id="ordersList">YÃ¼kleniyor...</div>
</div>

<div id="reviewModal" class="modal">
    <div class="modal-content">
        <h3 id="modalProductName" style="color:#d4af37;">DeÄŸerlendir</h3>
        <div class="stars" id="stars">
            <span onclick="setRating(1)">â˜†</span><span onclick="setRating(2)">â˜†</span><span onclick="setRating(3)">â˜†</span><span onclick="setRating(4)">â˜†</span><span onclick="setRating(5)">â˜†</span>
        </div>
        <textarea id="reviewComment" placeholder="ÃœrÃ¼n hakkÄ±ndaki dÃ¼ÅŸÃ¼nceleriniz..."></textarea>
        <button class="review-btn" style="width:100%; margin-top:15px; height: 40px;" onclick="submitReview()">GÃ–NDER</button>
        <button onclick="closeModal()" style="background:none; border:none; color:#888; margin-top:15px; cursor:pointer;">VazgeÃ§</button>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    let currentProductId = null, rating = 0;

    if(!token) window.location.href = "login.html";

    async function loadOrders() {
        try {
            const res = await fetch(`/api/orders/my-orders?t=${new Date().getTime()}`, {
                headers: { "Authorization": "Bearer " + token }
            });
            const orders = await res.json();
            const list = document.getElementById("ordersList");
            list.innerHTML = "";

            if (!orders || orders.length === 0) {
                list.innerHTML = "<p style='color:#888; text-align:center;'>HenÃ¼z bir sipariÅŸiniz bulunmuyor.</p>";
                return;
            }

            orders.forEach(order => {
                const card = document.createElement("div");
                card.className = "order-card";
                
                const productsHTML = order.items.map(i => {
                   
                    const prodId = (typeof i.product === 'object' && i.product !== null) ? i.product._id : i.product;
                    
                    return `
                        <div class="order-product-row">
                            <div class="product-info">
                                <img src="${i.image}" class="order-product-image">
                                <div>
                                    <div style="color:#fff; font-weight:bold;">${i.name}</div>
                                    <div style="color:#888; font-size:0.9em;">Adet: ${i.quantity} <br> Fiyat: ${i.price} â‚º</div>
                                </div>
                            </div>
                            <span style="color:#fff; font-weight:bold; margin: 0 15px;">${(i.price * (i.quantity || 1)).toFixed(2)} â‚º</span>
                            <button class="review-btn" onclick="openModal('${prodId}','${i.name.replace(/'/g, "\\'")}')">DEÄžERLENDÄ°R</button>
                        </div>
                    `;
                }).join("");

                card.innerHTML = `
                    <span class="order-date">ðŸ“¦ SipariÅŸ Tarihi: ${new Date(order.createdAt).toLocaleDateString('tr-TR')}</span>
                    ${productsHTML}
                    <div class="order-total">Toplam Ã–denen: ${order.totalAmount.toFixed(2)} â‚º</div>
                `;
                list.appendChild(card);
            });
        } catch (err) { 
            console.error("SipariÅŸler yÃ¼klenemedi:", err);
            document.getElementById("ordersList").innerHTML = "YÃ¼kleme hatasÄ±.";
        }
    }

    function openModal(id, name) {
      
        if (id.includes("object Object")) {
            alert("ÃœrÃ¼n bilgisi hatalÄ±, lÃ¼tfen sayfayÄ± yenileyip tekrar deneyin.");
            return;
        }
        currentProductId = id;
        document.getElementById("modalProductName").innerText = name;
        document.getElementById("reviewModal").style.display = "block";
        rating = 0; 
        updateStars();
        document.getElementById("reviewComment").value = "";
    }

    function closeModal() { document.getElementById("reviewModal").style.display = "none"; }
    
    function setRating(n) { rating = n; updateStars(); }
    
    function updateStars() {
        const starElements = document.getElementById("stars").children;
        for(let i=0; i<starElements.length; i++) {
            starElements[i].innerText = i < rating ? "â˜…" : "â˜†";
        }
    }

    async function submitReview() {
        if(!rating) return alert("LÃ¼tfen puan seÃ§in!");
        if(!currentProductId || currentProductId === "undefined") return alert("ÃœrÃ¼n ID hatasÄ±!");

        try {
            const res = await fetch(`/api/products/${currentProductId}/review`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "Authorization": "Bearer " + token 
                },
                body: JSON.stringify({ 
                    rating: Number(rating), 
                    comment: document.getElementById("reviewComment").value 
                })
            });
            
            const data = await res.json();
            
            if(res.ok && data.success !== false) {
                alert("Yorumunuz iletildi, teÅŸekkÃ¼rler!");
                closeModal();
            } else {
                alert("Yorum yapÄ±lamadÄ±: " + (data.message || "Bilinmeyen hata"));
            }
        } catch (err) { 
            console.error("Yorum hatasÄ±:", err);
            alert("Sunucu hatasÄ±!"); 
        }
    }

    loadOrders();
</script>
</body>
</html>