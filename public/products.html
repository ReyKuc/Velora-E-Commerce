<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Velora | Ürünler</title>
<link rel="stylesheet" href="css/style.css">
<style>
header {
    background-color: #000;
    padding: 20px 0 10px;
    border-bottom: 2px solid #d4af37;
}

nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 30px;
}

nav a {
    color: #f5f5f5;
    text-decoration: none;
    font-weight: 600;
    letter-spacing: 1px;
}

nav a:hover {
    color: #d4af37;
}

@media (max-width: 768px) {
    header {
        position: relative;
        border-bottom: none;
    }

    nav {
        display: none;
        position: absolute;
        top: 70px;
        right: 20px;
        background: black;
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
        border: 1px solid #d4af37;
        z-index: 1000;
    }

    nav.active {
        display: flex;
    }

    .hamburger {
        display: flex;
        flex-direction: column;
        gap: 6px;
        position: absolute;
        top: 25px;
        right: 20px;
        z-index: 1100;
        cursor: pointer;
    }

    .hamburger span {
        width: 28px;
        height: 3px;
        background: #ffffff;
    }
}

#categoryFilter {
    padding: 10px;
    margin-bottom: 20px;
    border-radius: 8px;
    border: 1px solid #d4af37;
    background-color: #1a1a1a;
    color: #f5f5f5;
    cursor: pointer;
}

.product-item {
    border: 1px solid #d4af37;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 10px;
    background-color: #0d0d0d;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative; 
}

.product-item.out-of-stock {
    opacity: 0.6;
    border-color: #666;
}

.product-image {
    width: 100px; 
    height: 100px; 
    object-fit: cover; 
    border-radius: 8px;
    margin-right: 15px;
}

.product-info {
    flex-grow: 1; 
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.stock-badge {
    display: inline-block;
    width: fit-content;
    padding: 5px 9px !important; 
    border-radius: 40px;          
    font-size: 10px;             
    font-weight: 60;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 5px;
    font-weight: bold;
}

.stock-high   { background-color: #2ecc71; color: #000; }
.stock-medium { background-color: #f39c12; color: #000; }
.stock-low    { background-color: #e74c3c; color: #fff; }
.stock-out    { background-color: #95a5a6; color: #fff; }

.stock-out {
    background-color: #95a5a6;
    color: #fff;
}

.product-actions-inline {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: 20px;
}

.add-to-cart-btn {
    background-color: #d4af37; 
    color: #0d0d0d;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}

.add-to-cart-btn:hover:not(:disabled) {
    background-color: #e0b84f;
}

.add-to-cart-btn:disabled {
    background-color: #666;
    cursor: not-allowed;
    opacity: 0.5;
}

.fav-btn {
    background: none !important; 
    border: none !important; 
    cursor: pointer;
    font-size: 30px !important; 
    padding: 0; 
    line-height: 1; 
    color: #f5f5f5; 
    transition: all 0.2s ease;
}

.fav-btn:hover {
    transform: scale(1.1);
    color: #ff4c4c;
}

.fav-btn.active {
    color: #ff4c4c; 
}
</style>
</head>
<body>
<header>
<h1 style="color: #d4af37;">VELORA</h1>
<nav id="navMenu">
    <a href="index.html">ANA SAYFA</a>
    <a href="products.html">ÜRÜNLER</a>
    <a href="cart.html">SEPETİM</a>
    <a href="favorites.html">FAVORİLER</a>
    <a href="login.html" id="loginLink">GİRİŞ YAP</a>
    <a href="register.html" id="registerLink">KAYIT OL</a>
    <a href="#" id="logoutBtn" class="logout-btn" style="display:none;">→</a>
    <div id="logoutConfirm" class="logout-confirm">
        <p>Çıkış yapmak istediğine emin misin?</p>
        <button id="confirmYes">Evet</button>
        <button id="confirmNo">Hayır</button>
    </div>
</nav>
<div class="hamburger" id="hamburger">
    <span></span>
    <span></span>
    <span></span>
</div>
</header>

<div class="form-container">
<h2>Ürünler</h2>

<select id="categoryFilter" onchange="loadProducts()">
    <option value="">Tüm Kategoriler</option>
    <option value="Kadın">Kadın</option>
    <option value="Erkek">Erkek</option>
    <option value="Kozmetik">Kozmetik</option>
    <option value="Aksesuar">Aksesuar</option>
    <option value="Çanta">Çanta</option>
    <option value="Ayakkabı">Ayakkabı</option>
</select>

<div id="productsList"></div>
</div>

<footer>
<p>&copy; 2025 VELORA</p>
</footer>

<script>
const productsDiv = document.getElementById("productsList");
const categoryFilter = document.getElementById("categoryFilter");
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

// Admin kontrolü
if (role === "admin") {
    window.location.href = "admin.html";
}

let userFavorites = new Set();

// Stock badge oluştur
function getStockBadge(stock) {
    if (stock === undefined || stock === null) {
        return '<span class="stock-badge stock-out">Stok Bilgisi Yok</span>';
    }
    
    if (stock <= 0) {
        return '<span class="stock-badge stock-out">Stokta Yok</span>';
    } else if (stock <= 10) {
        return `<span class="stock-badge stock-low">Son ${stock} adet!</span>`;
    } else if (stock <= 30) {
        return `<span class="stock-badge stock-medium">Stok: ${stock}</span>`;
    } else {
        return `<span class="stock-badge stock-high">Stok: ${stock}</span>`;
    }
}

async function loadUserFavorites() {
    if (!token || role === "admin") return; 
    try {
        const res = await fetch("/api/favorite", {
            headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        if (data.items) {
            userFavorites.clear();
            data.items.forEach(item => { 
                if(item.product) userFavorites.add(item.product._id); 
            });
        }
    } catch (err) { 
        console.error("Favori yükleme hatası:", err); 
    }
}

async function loadProducts() {
    // Önce kullanıcının favorilerini yükle (mevcut işleyiş)
    await loadUserFavorites();
    
    const urlParams = new URLSearchParams(window.location.search);
    let selectedCategory = categoryFilter.value || urlParams.get('category') || "";

    const apiUrl = selectedCategory ? `/api/products?category=${selectedCategory}` : "/api/products";

    try {
        const res = await fetch(apiUrl);
        const products = await res.json();
        
        productsDiv.innerHTML = "";
        
        // Eğer backend'den bir obje içinde "products" dizisi geliyorsa onu al, yoksa direkt diziyi kullan
        const productsArray = Array.isArray(products) ? products : (products.products || []);

        if (productsArray.length === 0) {
            productsDiv.innerHTML = "<p>Ürün bulunamadı.</p>";
            return;
        }

        productsArray.forEach(product => {
            const div = document.createElement("div");
            div.classList.add('product-item');
            
            // STOK KONTROLÜ: Verinin sayı olduğundan ve var olduğundan emin oluyoruz
            const currentStock = (product.stock !== undefined && product.stock !== null) ? Number(product.stock) : 0;
            
            // Tasarımındaki stokta yoksa grileştirme efekti
            if (currentStock <= 0) {
                div.classList.add('out-of-stock');
            }
            
            let actionButtons = "";

            if (role === "admin") {
                // Mevcut ADMIN tasarımı
                const btnClass = product.isActive ? "status-active" : "status-inactive";
                const btnText = product.isActive ? "Aktif (Yayında)" : "Pasif (Gizli)";
                
                actionButtons = `
                    <div class="product-actions-inline">
                        <button class="admin-status-btn ${btnClass}" data-id="${product._id}">
                            ${btnText}
                        </button>
                    </div>
                `;
            } else {
                // Mevcut USER tasarımı: Sepet ve Favori
                const isFavorite = userFavorites.has(product._id);
                const isOutOfStock = currentStock <= 0;
                
                actionButtons = `
                    <div class="product-actions-inline">
                        <button 
                            class="add-to-cart-btn" 
                            data-id="${product._id}"
                            ${isOutOfStock ? 'disabled' : ''}>
                            ${isOutOfStock ? 'Stokta Yok' : 'Sepete Ekle'}
                        </button>
                        <button class="fav-btn ${isFavorite ? 'active' : ''}" data-id="${product._id}">
                            ${isFavorite ? '♥' : '♡'}
                        </button> 
                    </div> 
                `;
            }

            // Mevcut HTML Yapısı (Değiştirilmedi)
            div.innerHTML = `
                <img src="${product.image}" alt="${product.name}" class="product-image">
                <div class="product-info">
                   <strong>${product.name}</strong>
                   <small style="color:#aaa;">Kategori: ${product.category}</small>
                   <span style="font-size: 1.2em; color: #d4af37; margin-top: 5px;">${product.price}₺</span>
                   ${getStockBadge(currentStock)}
                </div>
                ${actionButtons}
            `;
            productsDiv.appendChild(div);
        });

        attachEventListeners();

    } catch(err) {
        console.error("Ürün yükleme hatası:", err);
        productsDiv.innerHTML = "<p>Ürünler yüklenirken hata oluştu.</p>";
    }
}

function attachEventListeners() {
    // Sepete Ekle
    document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
        btn.onclick = async () => {
            if (!token) return alert("Önce giriş yapın!");
            if (btn.disabled) return; // Stokta yoksa işlem yapma
            
            const res = await fetch("/api/cart/add", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "Authorization": "Bearer " + token 
                },
                body: JSON.stringify({ productId: btn.dataset.id, quantity: 1 })
            });
            const data = await res.json();
            
            if (data.success) {
                alert("Sepete eklendi!");
                loadProducts(); // Stok güncellenebilir
            } else {
                alert(data.message || "Hata!");
            }
        };
    });

    // Favori Toggle
    document.querySelectorAll(".fav-btn").forEach(btn => {
        btn.onclick = async () => {
            if (!token) return alert("Önce giriş yapın!");
            const isFav = btn.classList.contains('active');
            const res = await fetch(`/api/favorite/${isFav ? 'remove' : 'add'}`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "Authorization": "Bearer " + token 
                },
                body: JSON.stringify({ productId: btn.dataset.id })
            });
            const data = await res.json();
            if(data.success) loadProducts();
        };
    });

    // ADMIN: Active/Inactive Toggle
    document.querySelectorAll(".admin-status-btn").forEach(btn => {
        btn.onclick = async () => {
            try {
                const res = await fetch(`/api/admin/products/toggle/${btn.dataset.id}`, {
                    method: "PATCH",
                    headers: { "Authorization": "Bearer " + token }
                });
                const data = await res.json();
                if(data.success) loadProducts();
            } catch(err) { 
                console.error("Toggle hatası:", err); 
            }
        };
    });
}

loadProducts();

// Hamburger Menü
const hamburger = document.getElementById("hamburger");
const nav = document.getElementById("navMenu");
if (hamburger) {
    hamburger.onclick = () => nav.classList.toggle("active");
}

// Logout Mantığı
const logoutBtn = document.getElementById("logoutBtn");
const logoutConfirm = document.getElementById("logoutConfirm");
const yesBtn = document.getElementById("confirmYes");
const noBtn = document.getElementById("confirmNo");

if (logoutConfirm) logoutConfirm.style.display = "none";

if (token) {
    if (logoutBtn) logoutBtn.style.display = "inline-block";
    const loginLink = document.getElementById("loginLink");
    const registerLink = document.getElementById("registerLink");
    if (loginLink) loginLink.style.display = "none";
    if (registerLink) registerLink.style.display = "none";
}

if (logoutBtn) {
    logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        if (logoutConfirm) logoutConfirm.style.display = "block";
    });
}

if (noBtn) {
    noBtn.addEventListener("click", () => {
        if (logoutConfirm) logoutConfirm.style.display = "none";
    });
}

if (yesBtn) {
    yesBtn.addEventListener("click", () => {
        localStorage.clear();
        if (logoutConfirm) {
            logoutConfirm.innerHTML = "<p>Çıkış yapıldı</p>";
            setTimeout(() => {
                window.location.href = "index.html";
            }, 1000);
        }
    });
}
</script>

</body>
</html>