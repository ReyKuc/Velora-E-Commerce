<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velora | √úr√ºnler</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap">
    <style>
        :root {
            --bg-color: #000;
            --text-color: #fff;
            --header-bg: #000;
            --card-bg: #0d0d0d;
            --gold: #d4af37;
            --border: #d4af37;
            --modal-bg: #1a1a1a;
            --review-item-bg: #050505;
        }

        body.light-mode {
            --bg-color: #f4f4f4;
            --text-color: #1a1a1a;
            --header-bg: #ffffff;
            --card-bg: #ffffff;
            --gold: #b8860b;
            --border: #b8860b;
            --modal-bg: #ffffff;
            --review-item-bg: #f9f9f9;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: 0.3s ease;
        }

        header {
            background-color: var(--header-bg);
            padding: 20px 0 10px;
            border-bottom: 2px solid var(--border);
            position: sticky; top: 0; z-index: 1000;
        }

        .hamburger { display: none; flex-direction: column; gap: 5px; cursor: pointer; position: absolute; right: 20px; top: 25px; }
        .hamburger span { width: 30px; height: 3px; background-color: var(--gold); border-radius: 2px; }

        nav { display: flex; justify-content: center; align-items: center; gap: 30px; }
        nav a { color: var(--text-color); text-decoration: none; font-weight: 600; font-size: 14px; transition: 0.3s; }
        nav a:hover { color: var(--gold); }

        .theme-toggle { background: none; border: 1px solid var(--gold); color: var(--gold); padding: 5px 12px; border-radius: 20px; cursor: pointer; }

        #productsList {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px; margin-top: 30px;
        }

        .product-item {
            background-color: var(--card-bg); border: 1px solid var(--border);
            border-radius: 15px; padding: 20px; position: relative; transition: 0.3s;
        }

        .product-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .product-image { width: 100%; height: 250px; object-fit: cover; border-radius: 10px; cursor: pointer; }

        .price-tag { display: block; font-size: 1.4em; color: var(--gold); font-weight: bold; margin: 10px 0; }

        .rating-container { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer; width: fit-content; }
        .stars-outer { position: relative; font-size: 18px; color: #444; }
        .stars-inner { position: absolute; top: 0; left: 0; overflow: hidden; color: #ffd700; white-space: nowrap; }
        .stars-outer::before, .stars-inner::before { content: "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ"; }
        .rev-count { font-size: 12px; opacity: 0.7; text-decoration: underline; }

        .add-to-cart-btn {
            background-color: var(--gold); color: #000; border: none;
            padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%;
        }

        .fav-btn {
            position: absolute; top: 30px; right: 30px; background: rgba(0,0,0,0.5);
            border-radius: 50%; width: 40px; height: 40px; border: none; color: white; cursor: pointer;
        }
        .fav-btn.active { color: #ff4c4c; }

        .reviews-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            z-index: 2000; padding: 20px; align-items: center; justify-content: center;
        }
        .reviews-modal.active { display: flex; }
        .modal-content {
            background: var(--modal-bg); padding: 30px; border-radius: 15px;
            width: 100%; max-width: 500px; border: 1px solid var(--gold);
            max-height: 80vh; display: flex; flex-direction: column;
        }
        #reviewsContainer { overflow-y: auto; margin-top: 15px; }
        .review-item {
            background: var(--review-item-bg); padding: 10px; border-radius: 8px;
            margin-bottom: 10px; border-left: 3px solid var(--gold);
        }

        @media (max-width: 768px) {
            .hamburger { display: flex; }
            nav {
                display: none; flex-direction: column; width: 100%; background: var(--header-bg);
                position: absolute; top: 70px; left: 0; padding: 20px 0; border-bottom: 1px solid var(--border);
            }
            nav.active { display: flex; }
        }
    </style>
</head>
<body id="mainBody">

<header>
    <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
    <h1 style="color: var(--gold); text-align: center; margin: 0 0 10px 0; font-size: 1.5rem;">VELORA</h1>
    <nav id="navMenu">
        <a href="index.html">ANA SAYFA</a>
        <a href="products.html">√úR√úNLER</a>
        <a href="cart.html">SEPETƒ∞M</a>
        <a href="favorites.html">FAVORƒ∞LER</a>
        <a href="login.html" id="loginLink">Gƒ∞Rƒ∞≈û YAP</a>
        <a href="register.html" id="registerLink">KAYIT OL</a>
        <button id="themeToggle" class="theme-toggle">üåô Mod</button>
        <a href="#" id="logoutBtn" style="display:none; color: var(--gold);">√áIKI≈û</a>
    </nav>
</header>

<div class="container" style="padding: 40px 20px; max-width: 1200px; margin: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
        <h2 style="color: var(--gold); margin: 0;">L√ºks Koleksiyon</h2>
        <select id="categoryFilter" onchange="loadProducts(true)" style="padding: 10px; background: var(--card-bg); color: var(--text-color); border: 1px solid var(--gold); border-radius: 5px;">
            <option value="">T√ºm Kategoriler</option>
            <option value="Kadƒ±n">Kadƒ±n</option>
            <option value="Erkek">Erkek</option>
            <option value="Kozmetik">Kozmetik</option>
            <option value="Aksesuar">Aksesuar</option>
            <option value="√áanta">√áanta</option>
            <option value="Ayakkabƒ±">Ayakkabƒ±</option>
        </select>
    </div>
    
    <div id="productsList">Y√ºkleniyor...</div>
</div>

<div id="reviewsModal" class="reviews-modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
        <h3 id="modalTitle" style="color: var(--gold); margin-top: 0;">Deƒüerlendirmeler</h3>
        <div id="reviewsContainer"></div>
        <button onclick="closeModal()" style="margin-top: 20px; background: var(--gold); border: none; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 5px;">Kapat</button>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    const productsDiv = document.getElementById("productsList");
    const body = document.getElementById("mainBody");
    const themeToggle = document.getElementById("themeToggle");
    const categoryFilter = document.getElementById("categoryFilter");
    let userFavorites = new Set();

    document.getElementById("hamburger").onclick = () => document.getElementById("navMenu").classList.toggle("active");

    const currentTheme = localStorage.getItem("theme") || "dark";
    if (currentTheme === "light") { body.classList.add("light-mode"); themeToggle.textContent = "‚òÄÔ∏è Mod"; }

    themeToggle.onclick = () => {
        body.classList.toggle("light-mode");
        const isLight = body.classList.contains("light-mode");
        localStorage.setItem("theme", isLight ? "light" : "dark");
        themeToggle.textContent = isLight ? "‚òÄÔ∏è Mod" : "üåô Mod";
    };

    // G√ºncellenmi≈ü loadProducts Fonksiyonu
    async function loadProducts(isManualChange = false) {
        if (token) await loadUserFavorites();

        // 1. URL'den parametreyi oku
        const urlParams = new URLSearchParams(window.location.search);
        const urlCategory = urlParams.get('category');

        // 2. Eƒüer kullanƒ±cƒ± manuel select deƒüi≈ütirmediyse ve URL'de kategori varsa, select'i ona ayarla
        if (!isManualChange && urlCategory) {
            categoryFilter.value = urlCategory;
        }

        const category = categoryFilter.value;
        const url = category ? `/api/products?category=${category}` : "/api/products";

        try {
            const res = await fetch(url);
            const products = await res.json();
            productsDiv.innerHTML = "";

            if (products.length === 0) {
                productsDiv.innerHTML = "<p>Bu kategoride √ºr√ºn bulunamadƒ±.</p>";
                return;
            }

            for (const p of products) {
                const isFav = userFavorites.has(p._id);
                const outOfStock = p.stock <= 0;
                
                let avgRating = 0;
                let reviewCount = 0;
                try {
                    const revRes = await fetch(`/api/products/${p._id}/reviews`);
                    const revData = await revRes.json();
                    reviewCount = revData.reviews ? revData.reviews.length : 0;
                    if(reviewCount > 0) {
                        avgRating = revData.reviews.reduce((s, r) => s + r.rating, 0) / reviewCount;
                    }
                } catch(e) {}

                const card = document.createElement("div");
                card.className = "product-item";
                card.innerHTML = `
                    <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${p._id}')">${isFav ? '‚ô•' : '‚ô°'}</button>
                    <img src="${p.image}" class="product-image" onclick="window.location.href='product-detail.html?id=${p._id}'">
                    <div class="product-info">
                        <strong>${p.name}</strong>
                        <div class="rating-container" onclick="openReviews('${p._id}', '${p.name}')">
                            <div class="stars-outer"><div class="stars-inner" style="width: ${(avgRating/5)*100}%"></div></div>
                            <span class="rev-count">(${reviewCount} yorum)</span>
                        </div>
                        <span class="price-tag">${p.price}‚Ç∫</span>
                        <div style="margin-bottom: 15px;">
                            ${outOfStock ? '<span style="color:#ff4c4c;">‚ùå T√ºkendi</span>' : `<span style="color:#2ecc71;">‚úÖ Stokta (${p.stock})</span>`}
                        </div>
                        <button class="add-to-cart-btn" onclick="addToCart('${p._id}')" ${outOfStock ? 'disabled' : ''}>
                            ${outOfStock ? 'T√úKENDƒ∞' : 'SEPETE EKLE'}
                        </button>
                    </div>
                `;
                productsDiv.appendChild(card);
            }
        } catch (err) { productsDiv.innerHTML = "√úr√ºnler y√ºklenirken hata olu≈ütu."; }
    }

    async function openReviews(productId, productName) {
        const modal = document.getElementById("reviewsModal");
        const container = document.getElementById("reviewsContainer");
        document.getElementById("modalTitle").innerText = productName + " - Yorumlar";
        container.innerHTML = "Y√ºkleniyor...";
        modal.classList.add("active");

        try {
            const res = await fetch(`/api/products/${productId}/reviews`);
            const data = await res.json();
            if (!data.reviews || data.reviews.length === 0) {
                container.innerHTML = "<p style='opacity:0.6;'>Hen√ºz yorum yapƒ±lmamƒ±≈ü.</p>";
                return;
            }
            container.innerHTML = data.reviews.map(r => `
                <div class="review-item">
                    <div style="color:var(--gold); font-weight:bold; font-size:14px;">${r.userName}</div>
                    <div style="color:#ffd700;">${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5-r.rating)}</div>
                    <p style="margin:5px 0; font-size:13px;">${r.comment}</p>
                    <small style="opacity:0.5;">${new Date(r.createdAt).toLocaleDateString('tr-TR')}</small>
                </div>
            `).join('');
        } catch (e) { container.innerHTML = "Yorumlar getirilemedi."; }
    }

    function closeModal() { document.getElementById("reviewsModal").classList.remove("active"); }

    async function loadUserFavorites() {
        try {
            const res = await fetch("/api/favorite", { headers: { "Authorization": "Bearer " + token } });
            const data = await res.json();
            if (data.items) {
                userFavorites.clear();
                data.items.forEach(item => item.product && userFavorites.add(item.product._id));
            }
        } catch (e) {}
    }

    async function addToCart(productId) {
        if (!token) return alert("L√ºtfen giri≈ü yapƒ±n.");
        const res = await fetch("/api/cart/add", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify({ productId, quantity: 1 })
        });
        if (res.ok) alert("Sepete eklendi!");
    }

    async function toggleFavorite(productId) {
        if (!token) return alert("L√ºtfen giri≈ü yapƒ±n.");
        const isFav = userFavorites.has(productId);
        await fetch(`/api/favorite/${isFav ? 'remove' : 'add'}`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify({ productId })
        });
        loadProducts(true);
    }

    if (token) {
        document.getElementById("logoutBtn").style.display = "inline-block";
        document.getElementById("loginLink").style.display = "none";
        document.getElementById("registerLink").style.display = "none";
    }

    document.getElementById("logoutBtn").onclick = () => { localStorage.clear(); window.location.href="index.html"; };

    loadProducts();
</script>
</body>
</html>